# Creates samir.pages.dev branch synced from main (for Cloudflare Pages)
# Updates baseURL and robots.txt with Cloudflare domain
name: Sync Cloudflare Pages Branch

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-cloudflare:
    runs-on: ubuntu-latest
    steps:
      # Checkout main branch with all submodules
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          submodules: recursive
          ssh-key: ${{ secrets.CONTENT_SUBMODULE_SSH_PRIVATE_KEY }}

      # Configure git identity
      - name: Setup git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Use HTTPS for pushing to allow writing
      - name: Setup HTTPS push credentials
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      # Create/sync cloudflare-pages branch with config updates
      - name: Sync cloudflare-pages branch
        run: |
          BRANCH="cloudflare-pages"
          REMOTE="origin"
          FROM="samirpaulb.github.io"
          TO="samir.pages.dev"
          FILES=("hugo.toml" "static/robots.txt")

          git fetch "$REMOTE"

          # Create or checkout cloudflare-pages branch
          if git ls-remote --heads "$REMOTE" "$BRANCH" | grep -q "$BRANCH"; then
            git checkout "$BRANCH"
          else
            git checkout -b "$BRANCH"
          fi

          # Sync with main branch
          git reset --hard "${REMOTE}/main"
          git submodule update --init --recursive --force

          # Replace GitHub Pages domain with Cloudflare domain
          changed=0
          for f in "${FILES[@]}"; do
            if [[ -f "$f" ]] && grep -q "${FROM}" "$f"; then
              sed -i "s|${FROM}|${TO}|g" "$f"
              changed=1
            fi
          done

          # Commit domain changes if any
          if [[ "$changed" -eq 1 ]]; then
            git add "${FILES[@]}"
            git commit -m "Update domain from ${FROM} to ${TO}"
          fi

          # Push cloudflare-pages branch
          git push --force-with-lease "$REMOTE" "$BRANCH"
          echo "âœ… Cloudflare Pages branch synced"