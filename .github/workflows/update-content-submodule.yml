# Automatically updates content submodule when content repo pushes changes
# Triggered by content repo webhook, then pushes to main
# Downstream workflows (hugo.yml & sync-cloudflare-pages-branch.yml) triggered by workflow_run
#
# Required secrets:
# - CONTENT_SUBMODULE_SSH_PRIVATE_KEY: SSH key to clone private content repo
# - PARENT_REPO_TOKEN (in content repo): Fine-grained PAT to trigger this workflow via repository_dispatch

name: UPDATE_CONTENT_SUBMODULE

on:
  repository_dispatch:
    types:
      - content-update
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-content:
    runs-on: ubuntu-latest
    steps:
      # Log which repo triggered this update
      - name: Log trigger source
        run: |
          echo "Triggered by: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "Repository: ${{ github.event.client_payload.repository }}"
            echo "Commit: ${{ github.event.client_payload.sha }}"
          fi

      # Clone blog repo with submodules (SSH key for private content, GITHUB_TOKEN for checkout)
      - name: Checkout blog repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}
          ssh-key: ${{ secrets.CONTENT_SUBMODULE_SSH_PRIVATE_KEY }}

      # Configure git for committing
      - name: Setup git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Reconfigure remote to use HTTPS for pushing (SSH key is read-only)
      - name: Setup HTTPS for push
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      # Fetch latest content from main branch and check for changes
      - name: UPDATE_CONTENT_SUBMODULE
        id: check_updates
        run: |
          # Get current commit in submodule
          cd content
          CONTENT_OLD=$(git rev-parse HEAD)
          cd ..

          # Fetch latest from remote
          cd content
          git fetch origin main
          CONTENT_NEW=$(git rev-parse origin/main)
          cd ..

          # Check if there are updates
          if [ "$CONTENT_OLD" = "$CONTENT_NEW" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No new content"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # Update submodule to point to latest commit
            cd content
            git checkout origin/main
            cd ..

            # Create commit message with changelog
            echo "## Content Update" > summary.md
            echo "Updated from \`${CONTENT_OLD:0:7}\` to \`${CONTENT_NEW:0:7}\`" >> summary.md
            echo "" >> summary.md

            cd content
            git log --oneline ${CONTENT_OLD}..${CONTENT_NEW} | head -10 | sed 's/^/- /' >> ../summary.md
            cd ..
          fi

      # Commit submodule update and push to main (downstream workflows triggered by workflow_run)
      - name: Push update to main branch
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          git add content

          # Create commit with summary
          git commit -m "UPDATE_CONTENT_SUBMODULE" -m "$(cat summary.md)"

          # Push to main (downstream workflows triggered by workflow_run, not by push event)
          git push origin main

          echo "âœ… Pushed to main - workflow_run will trigger Hugo build & Cloudflare sync"
