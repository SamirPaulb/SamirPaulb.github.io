name: Sync Cloudflare Pages Branch

on:
  push:
    branches: ["main"]
  workflow_dispatch:

# Allow the workflow to push to protected branches
permissions:
  contents: write

jobs:
  sync-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
          ref: main
          submodules: recursive  # Checkout submodules
          ssh-key: ${{ secrets.CONTENT_SUBMODULE_SSH_PRIVATE_KEY }}  # SSH key for private submodule

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Reconfigure remote to use GITHUB_TOKEN for push
        run: |
          # Change the remote URL to use HTTPS with GITHUB_TOKEN instead of SSH
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Sync cloudflare-pages branch
        run: |
          # Configuration
          BRANCH="cloudflare-pages"
          REMOTE="origin"
          FROM="samirpaulb.github.io"
          TO="samir.pages.dev"

          # Files to update
          FILES=("hugo.toml" "static/robots.txt")

          # Fetch latest changes
          git fetch "$REMOTE"

          # Check if branch exists remotely
          if git ls-remote --heads "$REMOTE" "$BRANCH" | grep -q "$BRANCH"; then
            echo "Branch $BRANCH exists, checking out..."
            git checkout "$BRANCH"
          else
            echo "Branch $BRANCH does not exist, creating..."
            git checkout -b "$BRANCH"
          fi

          # Reset to match main exactly
          git reset --hard "${REMOTE}/main"

          # Update submodules to match main's submodule commits
          echo "Updating submodules..."
          git submodule update --init --recursive --force

          # Replace domains in listed files
          changed=0
          for f in "${FILES[@]}"; do
            if [[ -f "$f" ]]; then
              if grep -q "${FROM}" "$f"; then
                sed -i "s|${FROM}|${TO}|g" "$f"
                changed=1
                echo "Updated $f"
              fi
            fi
          done

          # Commit and push if there are changes
          if [[ "$changed" -eq 1 ]] && ! git diff --quiet; then
            git add "${FILES[@]}"
            git commit -m "chore: replace ${FROM} with ${TO} in configured files"
            echo "Changes committed"
          else
            echo "No changes to commit"
          fi

          # Push to remote
          git push --force-with-lease "$REMOTE" "$BRANCH"
          echo "Branch $BRANCH synced successfully"
